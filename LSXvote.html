<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Theo dõi vote nghệ sĩ – Realtime (API 1vote)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h1 { text-align: center; }
    #controls { margin: 20px 0; }
    #controls label { margin-right: 16px; cursor: pointer; white-space: nowrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
  </style>
</head>
<body>
  <script>
console.log("SCRIPT ĐÃ LOAD");
</script>

<h1>Theo dõi vote nghệ sĩ – Làn Sóng Xanh 2025 (Realtime)</h1>

<canvas id="voteChart" height="120"></canvas>

<div id="controls"></div>

<table id="summaryTable">
  <tr><th>#</th><th>Nghệ sĩ</th><th>Vote hiện tại</th></tr>
</table>

<script>
// ====== CẤU HÌNH ======
// URL proxy Cloudflare Worker (THAY bằng URL của bạn sau khi deploy)
const API_URL = "https://lsxvote.jdiep72.workers.dev/";
const REFRESH_INTERVAL = 10000; // 10 giây

// ====== BIẾN TOÀN CỤC ======
let chart;
let artistsMap = {}; // key = artist id

// ====== HÀM TIỆN ÍCH ======
function randomColor() {
  return `hsl(${Math.floor(Math.random() * 360)},70%,50%)`;
}

// ====== KHỞI TẠO BIỂU ĐỒ ======
function initChart() {
  const ctx = document.getElementById('voteChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [], // trục thời gian
      datasets: []
    },
    options: {
      responsive: true,
      animation: false,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { title: { display: true, text: 'Thời gian' } },
        y: { title: { display: true, text: 'Số vote' } }
      }
    }
  });
}

// ====== BẬT / TẮT ĐƯỜNG CONG ======
function toggleDataset(index) {
  const ds = chart.data.datasets[index];
  ds.hidden = !ds.hidden;
  chart.update();
}

function renderControls() {
  const div = document.getElementById('controls');
  div.innerHTML = '<b>Bật / tắt nghệ sĩ:</b><br>';

  chart.data.datasets.forEach((ds, i) => {
    const label = document.createElement('label');
    label.innerHTML = `<input type="checkbox" checked onchange="toggleDataset(${i})"> ${ds.label}`;
    div.appendChild(label);
  });
}

// ====== BẢNG TỔNG ======
function updateTable(list) {
  const table = document.getElementById('summaryTable');
  table.innerHTML = '<tr><th>#</th><th>Nghệ sĩ</th><th>Vote hiện tại</th></tr>';

  list
    .sort((a, b) => b.points - a.points)
    .forEach((a, i) => {
      table.innerHTML += `<tr><td>${i + 1}</td><td>${a.name}</td><td>${a.points}</td></tr>`;
    });
}

// ====== FETCH & UPDATE REALTIME ======
async function refreshData() {
  const res = await fetch(API_URL);
  const json = await res.json();

  const products = json?.data?.products || [];
  const timeLabel = new Date().toLocaleTimeString();

  chart.data.labels.push(timeLabel);

  const summary = [];

  products.forEach(p => {
    // API này mỗi product chính là 1 nghệ sĩ
    if (!artistsMap[p.id]) {
      const dataset = {
        label: p.name,
        data: [],
        borderColor: randomColor(),
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.25
      };
      artistsMap[p.id] = dataset;
      chart.data.datasets.push(dataset);
    }

    artistsMap[p.id].data.push(p.points || 0);
    summary.push({ name: p.name, points: p.points || 0 });
  });

  chart.update();
  renderControls();
  updateTable(summary);
}

// ====== MAIN ======
async function main() {
  initChart();
  await refreshData();
  setInterval(refreshData, REFRESH_INTERVAL);
}

main();
</script>

</body>
</html>

